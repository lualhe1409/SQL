DECLARE @Ingreso  AS VARCHAR(30)    DECLARE @FechaHora  AS VARCHAR(30)    DECLARE @LoteInterno    AS VARCHAR(30)    DECLARE @LoteProveedor AS VARCHAR(30)    DECLARE @IDTipoIngreso  AS VARCHAR(30)    DECLARE @NombreIngreso  AS VARCHAR(30)    DECLARE @DotoReferencia AS VARCHAR(30)    DECLARE @CodigoProducto AS VARCHAR(30)     DECLARE @Producto  AS VARCHAR(30)     DECLARE @Cantidad       AS FLOAT = 0     DECLARE @Peso   AS FLOAT = 0     DECLARE @SumCantidad AS FLOAT = 0     DECLARE @SumPeso  AS FLOAT = 0     DECLARE @SumIngreso     AS INT = 0     DECLARE @CtrlIngreso AS VARCHAR(30)     DECLARE @TotalDoctos AS FLOAT = 0     DECLARE @TotalCantidad AS FLOAT = 0     DECLARE @TotalPeso  AS FLOAT = 0     DECLARE @NombreCia  AS VARCHAR(50)     DECLARE @FolioEntrada AS VARCHAR(50)     DECLARE @LoteFabricante AS VARCHAR(50)     DECLARE @IDCompania  AS VARCHAR(30) = '130'     DECLARE @IDBodega    AS VARCHAR(30) = '1'     DECLARE @FechaInicio AS VARCHAR(30) = '#FechaInicio#' + ' 00:00:00.000'     DECLARE @FechaFinal  AS VARCHAR(30) = '#FechaFinal#'   + ' 23:59:59.000'       DECLARE @Ctrl   AS VARCHAR(50) = '#'    IF @IDCompania   = '#Compania'  + @Ctrl   SET @IDCompania  = '%'            CREATE TABLE #IngresoGral (  NombreCia VARCHAR(50),  Ingreso VARCHAR(MAX),  FolioEntrada VARCHAR(50),  IDTipoIngreso VARCHAR(30),  TipoIngreso VARCHAR(30),     DocumentoReferencia VARCHAR(30),  FechaIngreso VARCHAR(30),  LoteInterno VARCHAR(MAX),  LoteProveedor VARCHAR(MAX),  LoteFabricante VARCHAR(50),     CodProdcuto VARCHAR(MAX),  Producto VARCHAR(MAX),  CantidadIngreso FLOAT,  PesoTotalKg FLOAT)          DECLARE C1 CURSOR FOR       SELECT c.Nombre AS 'Nombre compañía',    HTC.IDDocumentoIngreso AS 'Ingreso', DI.FolioEntrada AS 'Folio Entrada', DI.IDTipoIngreso AS 'Tipo Salida',  TS.Nombre AS 'Nombre Tipo Ingreso',    DI.DocumentoReferencia AS 'Documento Referencia', CONVERT(VARCHAR,max(HTC.FechaHora),3) AS 'Fecha Ingreso',   HTC.LoteInterno AS 'Lote Interno',    HTC.LoteProveedor AS 'Lote Proveedor',  HTC.LoteFabricante 'Lote Fabricante', HTC.IDProducto AS 'Cod. Producto', P.Nombre AS 'Producto',     ISNULL(SUM(HTC.Cantidad),0) AS 'Cantidad', ISNULL(SUM(HTC.FactorPeso*HTC.Cantidad),0) AS 'Peso Total Kg'        FROM Producto AS P (NOLOCK)          LEFT JOIN (SELECT  TC.IDDocumentoIngreso,   TC.FechaHora,  TC.LoteInterno,  TC.LoteProveedor,  TC.LoteFabricante,  TC.IDProducto,  TC.Cantidad,  TC.FactorPeso,  TC.IDCompania,      TC.IDBodega FROM     TransConjunto AS  TC (NOLOCK) WHERE IDTipoTransaccion = 2 AND Cantidad>0 AND IDDOCUMENTOINGRESO IN (SELECT IDDOCUMENTOINGRESO FROM DOCUMENTOINGRESO     WHERE IDTIPOINGRESO NOT IN (10)) UNION ALL       SELECT HTC.IDDocumentoIngreso , HTC.FechaHora, HTC.LoteInterno, HTC.LoteProveedor, HTC.LoteFabricante, HTC.IDProducto,     HTC.Cantidad, HTC.FactorPeso, HTC.IDCompania, HTC.IDBodega FROM HistTransConjunto AS HTC (NOLOCK) WHERE IDTipoTransaccion = 2 AND Cantidad>0     AND IDDocumentoIngreso in (SELECT IDDOCUMENTOINGRESO FROM DOCUMENTOINGRESO WHERE IDTIPOINGRESO NOT IN (10)))           HTC ON P.IDProducto = HTC.IDProducto AND P.IDCompania = HTC.IDCompania          LEFT JOIN DocumentoIngreso AS DI ON DI.IDDocumentoIngreso = HTC.IDDocumentoIngreso      LEFT JOIN TipoIngreso AS TS ON TS.IDTipoingreso = DI.IDTipoIngreso      LEFT JOIN Compania AS C ON c.IDCompania = HTC.IDCompania          WHERE 1 = 1      AND HTC.IDCompania LIKE @IDCompania      AND HTC.IDBodega   LIKE @IDBodega      AND HTC.FechaHora  >=   @FechaInicio      AND HTC.FechaHora  <=   @FechaFinal            GROUP BY HTC.FechaHora,HTC.IDDocumentoIngreso, HTC.LoteInterno, HTC.LoteProveedor, HTC.LoteFabricante,HTC.IDProducto, P.Nombre, DI.IDTipoIngreso,       DI.FolioEntrada,TS.Nombre, DI.DocumentoReferencia, C.Nombre          ORDER BY  HTC.IDDocumentoIngreso ASC,HTC.FechaHora ASC, HTC.IDProducto ASC, HTC.LoteInterno ASC             OPEN C1   FETCH NEXT FROM C1 INTO @NombreCia, @Ingreso, @FolioEntrada, @IDTipoIngreso, @NombreIngreso, @DotoReferencia, @FechaHora, @LoteInterno, @LoteProveedor,     @LoteFabricante, @CodigoProducto, @Producto, @Cantidad, @Peso    SET @CtrlIngreso = @Ingreso         WHILE @@FETCH_STATUS = 0 BEGIN      IF @CtrlIngreso <> @Ingreso BEGIN           INSERT INTO #IngresoGral VALUES(NULL,NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'SubTotal', @SumCantidad, @SumPeso)            SET @TotalDoctos += @SumIngreso            SET @TotalCantidad += @SumCantidad            SET @TotalPeso += @SumPeso      END ELSE BEGIN            SET @SumIngreso += 1            SET @SumCantidad += @Cantidad            SET @SumPeso  += @Peso      END          INSERT INTO #IngresoGral VALUES(@NombreCia, @Ingreso, @FolioEntrada, @IDTipoIngreso, @NombreIngreso, @DotoReferencia, @FechaHora, @LoteInterno, @LoteProveedor,     @LoteFabricante, @CodigoProducto, @Producto, @Cantidad, @Peso)   IF @CtrlIngreso <> @Ingreso BEGIN        SET @SumIngreso = 0 + 1        SET @SumCantidad = 0 + @Cantidad        SET @SumPeso  = 0 + @Peso        SET @CtrlIngreso  = @Ingreso   END  FETCH NEXT FROM C1 INTO @NombreCia, @Ingreso, @FolioEntrada, @IDTipoIngreso, @NombreIngreso,     @DotoReferencia, @FechaHora, @LoteInterno, @LoteProveedor, @LoteFabricante, @CodigoProducto, @Producto, @Cantidad, @Peso  END               INSERT INTO #IngresoGral VALUES(NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'Subtotal', @SumCantidad, @SumPeso)         SET @TotalDoctos   += @SumIngreso    SET @TotalCantidad += @SumCantidad    SET @TotalPeso     += @SumPeso        INSERT INTO #IngresoGral VALUES(NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'Total', @TotalCantidad, @TotalPeso)       CLOSE C1  DEALLOCATE C1  SELECT NombreCia, Ingreso, FolioEntrada, IDTipoIngreso, TipoIngreso, DocumentoReferencia,FechaIngreso, LoteInterno,      LoteProveedor, LoteFabricante, CodProdcuto, Producto, CantidadIngreso, PesoTotalKg  FROM #IngresoGral (NOLOCK)            DROP TABLE #IngresoGral      
